<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Personal Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --color-bg-main: #1A1A2E; /* Dark background */
            --color-bg-card: #2A2A4A; /* Slightly lighter card background */
            --color-bg-input: #3A3A5A; /* Input field background */
            --color-text-primary: #E0E0E0; /* Light text */
            --color-text-secondary: #A0A0B0; /* Secondary text */
            --color-text-accent: #FFD700; /* Gold accent for highlights */
            --color-text-dark: #1A1A2E; /* Dark text for buttons */
            --color-border: #5A5A7A; /* Border color */
            --color-link-hover: #C0C0D0; /* Hover for links */
            --color-success: #4CAF50; /* Green for success */
            --color-error: #F44336; /* Red for error */

            --font-body: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--color-bg-main);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg-main);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-secondary);
        }

        /* Chart container to prevent overflow */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            width: 100%;
            margin: 0 auto;
            max-width: 600px; /* Max width for larger screens */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-[var(--color-bg-card)] shadow-lg py-4 px-6 md:px-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-[var(--color-text-accent)]">My Library</h1>
            <nav>
                <ul class="flex space-x-4 md:space-x-6">
                    <li><a href="#dashboard" class="text-[var(--color-text-primary)] hover:text-[var(--color-link-hover)] font-medium transition-colors">Dashboard</a></li>
                    <li><a href="#books" class="text-[var(--color-text-primary)] hover:text-[var(--color-link-hover)] font-medium transition-colors">Books</a></li>
                    <li><a href="#borrowings" class="text-[var(--color-text-primary)] hover:text-[var(--color-link-hover)] font-medium transition-colors">Borrowings</a></li>
                    <li><a href="#settings" class="text-[var(--color-text-primary)] hover:text-[var(--color-link-hover)] font-medium transition-colors">Settings</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto px-6 md:px-8 py-8">

        <!-- Dashboard Section -->
        <section id="dashboard" class="mb-12">
            <h2 class="text-3xl font-bold mb-6 text-[var(--color-text-primary)]">Dashboard Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-[var(--color-bg-card)] p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm text-[var(--color-text-secondary)]">Total Books</p>
                        <p class="text-4xl font-bold text-[var(--color-text-accent)]" id="total-books">0</p>
                    </div>
                    <i class="fas fa-book text-5xl text-[var(--color-text-secondary)]"></i>
                </div>
                <div class="bg-[var(--color-bg-card)] p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm text-[var(--color-text-secondary)]">Books Borrowed Out</p>
                        <p class="text-4xl font-bold text-[var(--color-text-accent)]" id="books-borrowed">0</p>
                    </div>
                    <i class="fas fa-hand-holding-box text-5xl text-[var(--color-text-secondary)]"></i>
                </div>
                <div class="bg-[var(--color-bg-card)] p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-sm text-[var(--color-text-secondary)]">Books Available</p>
                        <p class="text-4xl font-bold text-[var(--color-text-accent)]" id="books-available">0</p>
                    </div>
                    <i class="fas fa-box-open text-5xl text-[var(--color-text-secondary)]"></i>
                </div>
            </div>

            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-[var(--color-bg-card)] p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-primary)]">Books by Genre</h3>
                    <div class="chart-container">
                        <canvas id="genreChart"></canvas>
                    </div>
                </div>
                <div class="bg-[var(--color-bg-card)] p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-primary)]">Borrowing Activity</h3>
                    <div class="chart-container">
                        <canvas id="borrowingChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Book Catalog Section -->
        <section id="books" class="mb-12">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-[var(--color-text-primary)]">My Book Catalog</h2>
                <button id="addBookBtn" class="bg-[var(--color-text-accent)] text-[var(--color-text-dark)] px-5 py-2 rounded-md font-semibold hover:bg-opacity-90 transition-colors flex items-center">
                    <i class="fas fa-plus mr-2"></i> Add New Book
                </button>
            </div>

            <div class="bg-[var(--color-bg-card)] rounded-lg shadow-md overflow-hidden">
                <div class="p-6 border-b border-[var(--color-border)]">
                    <input type="text" id="searchBooks" placeholder="Search books by title, author, or genre..."
                           class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div class="p-4" id="bookList">
                    <!-- Book cards will be dynamically loaded here -->
                </div>
            </div>
        </section>

        <!-- Borrowing Tracking Section -->
        <section id="borrowings" class="mb-12">
            <h2 class="text-3xl font-bold mb-6 text-[var(--color-text-primary)]">Borrowing Tracking</h2>
            <div class="bg-[var(--color-bg-card)] rounded-lg shadow-md overflow-hidden">
                <div class="p-6 border-b border-[var(--color-border)]">
                    <input type="text" id="searchBorrowings" placeholder="Search borrowings by book title or borrower..."
                           class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div class="p-4" id="borrowingList">
                    <!-- Borrowing records will be dynamically loaded here -->
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="mb-12">
            <h2 class="text-3xl font-bold mb-6 text-[var(--color-text-primary)]">Settings</h2>
            <div class="bg-[var(--color-bg-card)] p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-primary)]">User Profile</h3>
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">Username</label>
                    <input type="text" id="username" value="LibraryOwner" class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div class="mb-6">
                    <label for="email" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">Email</label>
                    <input type="email" id="email" value="owner@example.com" class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>

                <h3 class="text-xl font-semibold mb-4 text-[var(--color-text-primary)]">Data Export</h3>
                <button id="exportBooksBtn" class="bg-[var(--color-text-accent)] text-[var(--color-text-dark)] px-5 py-2 rounded-md font-semibold hover:bg-opacity-90 transition-colors flex items-center">
                    <i class="fas fa-file-export mr-2"></i> Export Books
                </button>
                <button id="exportBorrowingsBtn" class="bg-[var(--color-text-accent)] text-[var(--color-text-dark)] px-5 py-2 rounded-md font-semibold hover:bg-opacity-90 transition-colors flex items-center ml-4">
                    <i class="fas fa-file-export mr-2"></i> Export Borrowings
                </button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-[var(--color-bg-card)] py-6 px-6 md:px-8 text-center text-sm text-[var(--color-text-secondary)]">
        <p>&copy; 2024 My Personal Library. All rights reserved.</p>
    </footer>

    <!-- Book Modal -->
    <div id="bookModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-[var(--color-bg-card)] rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 class="text-2xl font-bold mb-6 text-[var(--color-text-primary)]" id="modalTitle">Add New Book</h3>
            <form id="bookForm" class="space-y-4">
                <input type="hidden" id="bookId">
                <div>
                    <label for="title" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Title</label>
                    <input type="text" id="title" required class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div>
                    <label for="author" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Author</label>
                    <input type="text" id="author" required class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div>
                    <label for="genre" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Genre</label>
                    <input type="text" id="genre" required class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div>
                    <label for="isbn" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">ISBN (Optional)</label>
                    <input type="text" id="isbn" class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div>
                    <label for="publicationYear" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Publication Year (Optional)</label>
                    <input type="number" id="publicationYear" min="1800" max="2099" class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Status</label>
                    <select id="status" required class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                        <option value="available">Available</option>
                        <option value="borrowed">Borrowed</option>
                        <option value="lost">Lost</option>
                        <option value="damaged">Damaged</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBookBtn" class="px-5 py-2 rounded-md text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors">Cancel</button>
                    <button type="submit" class="bg-[var(--color-text-accent)] text-[var(--color-text-dark)] px-5 py-2 rounded-md font-semibold hover:bg-opacity-90 transition-colors">Save Book</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Borrowing Modal -->
    <div id="borrowingModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-[var(--color-bg-card)] rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 class="text-2xl font-bold mb-6 text-[var(--color-text-primary)]" id="borrowingModalTitle">Add Borrowing Record</h3>
            <form id="borrowingForm" class="space-y-4">
                <input type="hidden" id="borrowingId">
                <div>
                    <label for="borrowingBookId" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Book</label>
                    <select id="borrowingBookId" required class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label for="borrowerName" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Borrower Name</label>
                    <input type="text" id="borrowerName" required class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div>
                    <label for="borrowDate" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Borrow Date</label>
                    <input type="date" id="borrowDate" required class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div>
                    <label for="returnDate" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Return Date (Optional)</label>
                    <input type="date" id="returnDate" class="w-full p-3 rounded-md bg-[var(--color-bg-input)] text-[var(--color-text-primary)] border border-[var(--color-border)] focus:outline-none focus:border-[var(--color-text-accent)]">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBorrowingBtn" class="px-5 py-2 rounded-md text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors">Cancel</button>
                    <button type="submit" class="bg-[var(--color-text-accent)] text-[var(--color-text-dark)] px-5 py-2 rounded-md font-semibold hover:bg-opacity-90 transition-colors">Save Borrowing</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const books = JSON.parse(localStorage.getItem('books')) || [];
            const borrowings = JSON.parse(localStorage.getItem('borrowings')) || [];
            let currentBookId = null;
            let currentBorrowingId = null;

            const totalBooksEl = document.getElementById('total-books');
            const booksBorrowedEl = document.getElementById('books-borrowed');
            const booksAvailableEl = document.getElementById('books-available');
            const bookListEl = document.getElementById('bookList');
            const borrowingListEl = document.getElementById('borrowingList');
            const addBookBtn = document.getElementById('addBookBtn');
            const bookModal = document.getElementById('bookModal');
            const borrowingModal = document.getElementById('borrowingModal');
            const bookForm = document.getElementById('bookForm');
            const borrowingForm = document.getElementById('borrowingForm');
            const searchBooksInput = document.getElementById('searchBooks');
            const searchBorrowingsInput = document.getElementById('searchBorrowings');

            // Chart instances
            let genreChart, borrowingChart;

            // --- Helper Functions ---
            const saveData = () => {
                localStorage.setItem('books', JSON.stringify(books));
                localStorage.setItem('borrowings', JSON.stringify(borrowings));
                renderDashboard();
                renderBooks();
                renderBorrowings();
            };

            const getAvailableBooksCount = () => books.filter(book => book.status === 'available').length;
            const getBorrowedBooksCount = () => books.filter(book => book.status === 'borrowed').length;
            const getTotalBooksCount = () => books.length;

            const renderDashboard = () => {
                totalBooksEl.textContent = getTotalBooksCount();
                booksBorrowedEl.textContent = getBorrowedBooksCount();
                booksAvailableEl.textContent = getAvailableBooksCount();

                renderGenreChart();
                renderBorrowingChart();
            };

            const renderBooks = (filter = '') => {
                bookListEl.innerHTML = '';
                const filteredBooks = books.filter(book =>
                    book.title.toLowerCase().includes(filter.toLowerCase()) ||
                    book.author.toLowerCase().includes(filter.toLowerCase()) ||
                    book.genre.toLowerCase().includes(filter.toLowerCase())
                );

                if (filteredBooks.length === 0) {
                    bookListEl.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] py-4">No books found matching your search.</p>';
                    return;
                }

                filteredBooks.forEach(book => {
                    const statusClass = book.status === 'borrowed' ? 'text-[var(--color-error)]' : 'text-[var(--color-success)]';
                    const statusText = book.status.charAt(0).toUpperCase() + book.status.slice(1);

                    const bookCard = `
                        <div class="book-item bg-[var(--color-bg-input)] p-4 rounded-lg shadow-md mb-4 flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div class="flex-grow mb-4 md:mb-0">
                                <h3 class="text-xl font-semibold text-[var(--color-text-primary)]">${book.title}</h3>
                                <p class="text-sm text-[var(--color-text-secondary)]">by ${book.author}</p>
                                <p class="text-xs text-[var(--color-text-secondary)]">Genre: ${book.genre}</p>
                                <p class="text-xs text-[var(--color-text-secondary)]">Status: <span class="${statusClass}">${statusText}</span></p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="edit-book-btn text-[var(--color-text-accent)] hover:text-[var(--color-link-hover)] px-3 py-1 rounded-md transition-colors" data-id="${book.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="delete-book-btn text-[var(--color-error)] hover:text-[var(--color-text-secondary)] px-3 py-1 rounded-md transition-colors" data-id="${book.id}">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                                ${book.status === 'available' ? `<button class="borrow-book-btn bg-[var(--color-text-accent)] text-[var(--color-text-dark)] px-3 py-1 rounded-md hover:bg-opacity-90 transition-colors" data-id="${book.id}">
                                    <i class="fas fa-hand-holding-box"></i> Borrow
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                    bookListEl.innerHTML += bookCard;
                });

                // Add event listeners for dynamic buttons
                document.querySelectorAll('.edit-book-btn').forEach(btn => {
                    btn.onclick = (e) => openBookModal(e.target.dataset.id);
                });
                document.querySelectorAll('.delete-book-btn').forEach(btn => {
                    btn.onclick = (e) => deleteBook(e.target.dataset.id);
                });
                document.querySelectorAll('.borrow-book-btn').forEach(btn => {
                    btn.onclick = (e) => openBorrowingModal(e.target.dataset.id);
                });
            };

            const renderBorrowings = (filter = '') => {
                borrowingListEl.innerHTML = '';
                const filteredBorrowings = borrowings.filter(borrowing =>
                    borrowing.bookTitle.toLowerCase().includes(filter.toLowerCase()) ||
                    borrowing.borrowerName.toLowerCase().includes(filter.toLowerCase())
                );

                if (filteredBorrowings.length === 0) {
                    borrowingListEl.innerHTML = '<p class="text-center text-[var(--color-text-secondary)] py-4">No borrowing records found matching your search.</p>';
                    return;
                }

                filteredBorrowings.forEach(borrowing => {
                    const statusClass = borrowing.returned ? 'text-[var(--color-success)]' : 'text-[var(--color-text-secondary)]';
                    const statusText = borrowing.returned ? 'Returned' : 'Outstanding';

                    const borrowingCard = `
                        <div class="borrowing-item bg-[var(--color-bg-input)] p-4 rounded-lg shadow-md mb-4 flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div class="flex-grow mb-4 md:mb-0">
                                <h3 class="text-lg font-semibold text-[var(--color-text-primary)]">${borrowing.bookTitle}</h3>
                                <p class="text-sm text-[var(--color-text-secondary)]">Borrower: ${borrowing.borrowerName}</p>
                                <p class="text-xs text-[var(--color-text-secondary)]">Borrow Date: ${borrowing.borrowDate}</p>
                                <p class="text-xs text-[var(--color-text-secondary)]">Return Date: ${borrowing.returnDate || 'N/A'}</p>
                                <p class="text-xs text-[var(--color-text-secondary)]">Status: <span class="${statusClass}">${statusText}</span></p>
                            </div>
                            <div class="flex space-x-2">
                                ${!borrowing.returned ? `<button class="return-book-btn bg-[var(--color-success)] text-[var(--color-text-dark)] px-3 py-1 rounded-md hover:bg-opacity-90 transition-colors" data-id="${borrowing.id}">
                                    <i class="fas fa-check-circle"></i> Return
                                </button>` : ''}
                                <button class="delete-borrowing-btn text-[var(--color-error)] hover:text-[var(--color-text-secondary)] px-3 py-1 rounded-md transition-colors" data-id="${borrowing.id}">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    borrowingListEl.innerHTML += borrowingCard;
                });

                // Add event listeners for dynamic buttons
                document.querySelectorAll('.return-book-btn').forEach(btn => {
                    btn.onclick = (e) => returnBook(e.target.dataset.id);
                });
                document.querySelectorAll('.delete-borrowing-btn').forEach(btn => {
                    btn.onclick = (e) => deleteBorrowing(e.target.dataset.id);
                });
            };

            const renderGenreChart = () => {
                const genreCounts = {};
                books.forEach(book => {
                    genreCounts[book.genre] = (genreCounts[book.genre] || 0) + 1;
                });

                const labels = Object.keys(genreCounts);
                const data = Object.values(genreCounts);

                if (genreChart) {
                    genreChart.destroy();
                }

                const ctx = document.getElementById('genreChart').getContext('2d');
                genreChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#FFD700', '#4CAF50', '#2196F3', '#9C27B0', '#FF5722', '#607D8B', '#FFC107', '#00BCD4', '#E91E63', '#8BC34A'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: 'var(--color-text-secondary)',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            const renderBorrowingChart = () => {
                const borrowingCounts = {};
                borrowings.forEach(borrowing => {
                    const year = new Date(borrowing.borrowDate).getFullYear();
                    borrowingCounts[year] = (borrowingCounts[year] || 0) + 1;
                });

                const labels = Object.keys(borrowingCounts).sort((a, b) => a - b);
                const data = labels.map(year => borrowingCounts[year]);

                if (borrowingChart) {
                    borrowingChart.destroy();
                }

                const ctx = document.getElementById('borrowingChart').getContext('2d');
                borrowingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Borrowings per Year',
                            data: data,
                            backgroundColor: 'rgba(255, 215, 0, 0.7)', // var(--color-text-accent)
                            borderColor: 'var(--color-text-accent)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--color-text-secondary)',
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'var(--color-border)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--color-text-secondary)',
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'var(--color-border)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y}`;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            // --- Book Modal Functions ---
            const openBookModal = (id = null) => {
                bookModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // Prevent scrolling
                currentBookId = id;

                if (currentBookId) {
                    const book = books.find(b => b.id === currentBookId);
                    if (book) {
                        document.getElementById('modalTitle').textContent = 'Edit Book';
                        document.getElementById('bookId').value = book.id;
                        document.getElementById('title').value = book.title;
                        document.getElementById('author').value = book.author;
                        document.getElementById('genre').value = book.genre;
                        document.getElementById('isbn').value = book.isbn || '';
                        document.getElementById('publicationYear').value = book.publicationYear || '';
                        document.getElementById('status').value = book.status;
                    }
                } else {
                    document.getElementById('modalTitle').textContent = 'Add New Book';
                    bookForm.reset();
                    document.getElementById('bookId').value = ''; // Clear hidden input
                }
            };

            const closeBookModal = () => {
                bookModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                currentBookId = null;
                bookForm.reset();
            };

            const openBorrowingModal = (bookId = null) => {
                borrowingModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // Prevent scrolling
                currentBorrowingId = null; // Reset for new borrowing

                // Populate book options for borrowing
                const bookSelect = document.getElementById('borrowingBookId');
                bookSelect.innerHTML = '<option value="">Select a Book</option>'; // Clear previous options
                books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = `${book.title} by ${book.author}`;
                    bookSelect.appendChild(option);
                });

                // Set the selected book if provided
                if (bookId) {
                    const selectedBook = books.find(b => b.id === bookId);
                    if (selectedBook) {
                        bookSelect.value = bookId; // Set the value of the select
                        document.getElementById('borrowingModalTitle').textContent = 'Add Borrowing for ' + selectedBook.title;
                    }
                } else {
                    document.getElementById('borrowingModalTitle').textContent = 'Add New Borrowing';
                }
            };

            const closeBorrowingModal = () => {
                borrowingModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                currentBorrowingId = null;
                borrowingForm.reset();
            };

            // --- Event Listeners ---
            addBookBtn.addEventListener('click', () => openBookModal());
            document.getElementById('cancelBookBtn').addEventListener('click', closeBookModal);
            document.getElementById('cancelBorrowingBtn').addEventListener('click', closeBorrowingModal);

            bookModal.addEventListener('click', (e) => {
                if (e.target === bookModal) closeBookModal();
            });
            borrowingModal.addEventListener('click', (e) => {
                if (e.target === borrowingModal) closeBorrowingModal();
            });

            bookForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(bookForm);
                const bookData = {};
                for (let [key, value] of formData.entries()) {
                    bookData[key] = value;
                }

                if (bookData.id) {
                    // Update existing book
                    const index = books.findIndex(b => b.id === bookData.id);
                    if (index !== -1) {
                        books[index] = bookData;
                        saveData();
                        alert('Book updated successfully!');
                    }
                } else {
                    // Add new book
                    bookData.id = Date.now().toString(); // Simple unique ID
                    books.push(bookData);
                    saveData();
                    alert('Book added successfully!');
                }
                closeBookModal();
            });

            borrowingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(borrowingForm);
                const borrowingData = {};
                for (let [key, value] of formData.entries()) {
                    borrowingData[key] = value;
                }

                const selectedBook = books.find(b => b.id === borrowingData.bookId);
                if (!selectedBook) {
                    alert('Selected book not found!');
                    return;
                }
                borrowingData.bookTitle = selectedBook.title;
                borrowingData.bookAuthor = selectedBook.author; // Add author for display
                borrowingData.returned = false; // Default status

                borrowings.push(borrowingData);
                saveData();
                alert('Borrowing record added successfully!');
                closeBorrowingModal();
            });

            bookListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-book-btn')) {
                    if (confirm('Are you sure you want to delete this book?')) {
                        deleteBook(e.target.dataset.id);
                    }
                } else if (e.target.classList.contains('edit-book-btn')) {
                    openBookModal(e.target.dataset.id);
                } else if (e.target.classList.contains('borrow-book-btn')) {
                    openBorrowingModal(e.target.dataset.id);
                }
            });

            borrowingListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-borrowing-btn')) {
                    if (confirm('Are you sure you want to delete this borrowing record?')) {
                        deleteBorrowing(e.target.dataset.id);
                    }
                } else if (e.target.classList.contains('return-book-btn')) {
                    returnBook(e.target.dataset.id);
                }
            });

            searchBooksInput.addEventListener('input', (e) => renderBooks(e.target.value));
            searchBorrowingsInput.addEventListener('input', (e) => renderBorrowings(e.target.value));

            // --- Core Data Operations ---
            const deleteBook = (id) => {
                books = books.filter(book => book.id !== id);
                saveData();
            };

            const returnBook = (id) => {
                const borrowingIndex = borrowings.findIndex(b => b.id === id);
                if (borrowingIndex !== -1) {
                    borrowings[borrowingIndex].returned = true;
                    borrowings[borrowingIndex].returnDate = new Date().toISOString().split('T')[0]; // Today's date
                    saveData();
                    alert('Book marked as returned!');
                }
            };

            const deleteBorrowing = (id) => {
                borrowings = borrowings.filter(borrowing => borrowing.id !== id);
                saveData();
            };

            // --- Initial Load ---
            renderDashboard();
            renderBooks();
            renderBorrowings();

            // Export functions
            document.getElementById('exportBooksBtn').addEventListener('click', () => {
                const csv = "Title,Author,Genre,ISBN,Publication Year,Status\n" +
                             books.map(book => `"${book.title}","${book.author}","${book.genre}","${book.isbn || ''}","${book.publicationYear || ''}","${book.status}"`).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'library_books.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });

            document.getElementById('exportBorrowingsBtn').addEventListener('click', () => {
                const csv = "Book Title,Borrower Name,Borrow Date,Return Date,Status\n" +
                             borrowings.map(borrowing => `"${borrowing.bookTitle}","${borrowing.borrowerName}","${borrowing.borrowDate}","${borrowing.returnDate || ''}","${borrowing.returned ? 'Returned' : 'Outstanding'}"`).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'library_borrowings.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
        });
    </script>
</body>
</html>