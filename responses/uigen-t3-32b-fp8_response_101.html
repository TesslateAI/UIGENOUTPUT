<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Form Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --color-white: rgb(255, 255, 255);
            --color-primary-dark: rgb(18, 20, 41);
            --color-primary-blue: rgb(19, 106, 229);
            --color-light-gray: rgb(247, 247, 248);
            --color-border-light: rgb(222, 226, 230);
            --color-text-muted: rgb(90, 96, 116);
            --color-text-dark: rgb(34, 38, 56);
            --color-dark-blue-gray: rgb(27, 34, 62);
            --color-accent-border: rgb(186, 221, 255);
            --color-accent-bg: rgb(224, 239, 254);
            --color-accent-blue: rgb(59, 130, 246);
            --color-success: rgb(34, 197, 94);
            --color-error: rgb(239, 68, 68);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-light-gray);
            color: var(--color-primary-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .form-builder-container {
            display: flex;
            height: calc(100vh - 64px); /* Adjust for header height */
        }

        .palette-section, .form-canvas {
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .palette-section {
            width: 250px;
            background-color: var(--color-white);
            border-right: 1px solid var(--color-border-light);
            overflow-y: auto;
        }

        .form-canvas {
            flex-grow: 1;
            background-color: var(--color-white);
            position: relative;
            min-height: 100%;
            overflow-y: auto;
        }

        .palette-item, .form-field {
            cursor: grab;
            transition: background-color 0.2s ease;
        }

        .palette-item:hover, .form-field:hover {
            background-color: var(--color-accent-bg);
        }

        .drop-target {
            min-height: 50px;
            border: 2px dashed var(--color-border-light);
            background-color: var(--color-accent-bg);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .drop-target.drag-over {
            background-color: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
            color: var(--color-white);
        }

        .form-field {
            background-color: var(--color-light-gray);
            border: 1px solid var(--color-border-light);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-field.dragging {
            opacity: 0.5;
            border: 2px dashed var(--color-primary-blue);
        }

        .conditional-block {
            background-color: var(--color-accent-bg);
            border: 1px solid var(--color-accent-border);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .conditional-block.dragging {
            opacity: 0.5;
            border: 2px dashed var(--color-primary-blue);
        }

        .conditional-logic {
            background-color: var(--color-white);
            border: 1px solid var(--color-border-light);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .conditional-logic.dragging {
            opacity: 0.5;
            border: 2px dashed var(--color-primary-blue);
        }

        .validation-message {
            color: var(--color-error);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="bg-[var(--color-light-gray)]">

    <header class="bg-[var(--color-white)] shadow-sm py-4 px-6 flex justify-between items-center z-10">
        <h1 class="text-2xl font-bold text-[var(--color-primary-dark)]">Form Builder</h1>
        <div class="flex items-center space-x-4">
            <button class="bg-[var(--color-primary-blue)] text-[var(--color-white)] px-5 py-2 rounded-lg font-medium hover:bg-opacity-90 transition-colors flex items-center">
                <i class="fas fa-save mr-2"></i> Save Form
            </button>
            <button class="bg-[var(--color-light-gray)] text-[var(--color-primary-dark)] px-5 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors flex items-center">
                <i class="fas fa-play mr-2"></i> Preview
            </button>
            <button class="bg-[var(--color-light-gray)] text-[var(--color-primary-dark)] px-5 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors flex items-center">
                <i class="fas fa-share-alt mr-2"></i> Share
            </button>
        </div>
    </header>

    <div class="form-builder-container">
        <!-- Palette Section -->
        <div class="palette-section">
            <h2 class="text-lg font-semibold mb-4 text-[var(--color-primary-dark)]">Form Elements</h2>
            <div id="palette" class="space-y-3">
                <div class="palette-item p-3 bg-white rounded-md shadow-sm border border-[var(--color-border-light)] flex items-center justify-between" draggable="true" data-type="text">
                    <span class="font-medium text-[var(--color-primary-dark)]">Text Input</span>
                    <i class="fas fa-grip-vertical text-[var(--color-text-muted)]"></i>
                </div>
                <div class="palette-item p-3 bg-white rounded-md shadow-sm border border-[var(--color-border-light)] flex items-center justify-between" draggable="true" data-type="textarea">
                    <span class="font-medium text-[var(--color-primary-dark)]">Text Area</span>
                    <i class="fas fa-grip-vertical text-[var(--color-text-muted)]"></i>
                </div>
                <div class="palette-item p-3 bg-white rounded-md shadow-sm border border-[var(--color-border-light)] flex items-center justify-between" draggable="true" data-type="number">
                    <span class="font-medium text-[var(--color-primary-dark)]">Number Input</span>
                    <i class="fas fa-grip-vertical text-[var(--color-text-muted)]"></i>
                </div>
                <div class="palette-item p-3 bg-white rounded-md shadow-sm border border-[var(--color-border-light)] flex items-center justify-between" draggable="true" data-type="email">
                    <span class="font-medium text-[var(--color-primary-dark)]">Email Input</span>
                    <i class="fas fa-grip-vertical text-[var(--color-text-muted)]"></i>
                </div>
                <div class="palette-item p-3 bg-white rounded-md shadow-sm border border-[var(--color-border-light)] flex items-center justify-between" draggable="true" data-type="select">
                    <span class="font-medium text-[var(--color-primary-dark)]">Select Dropdown</span>
                    <i class="fas fa-grip-vertical text-[var(--color-text-muted)]"></i>
                </div>
                <div class="palette-item p-3 bg-white rounded-md shadow-sm border border-[var(--color-border-light)] flex items-center justify-between" draggable="true" data-type="checkbox">
                    <span class="font-medium text-[var(--color-primary-dark)]">Checkbox</span>
                    <i class="fas fa-grip-vertical text-[var(--color-text-muted)]"></i>
                </div>
                <div class="palette-item p-3 bg-white rounded-md shadow-sm border border-[var(--color-border-light)] flex items-center justify-between" draggable="true" data-type="radio">
                    <span class="font-medium text-[var(--color-primary-dark)]">Radio Buttons</span>
                    <i class="fas fa-grip-vertical text-[var(--color-text-muted)]"></i>
                </div>
                <div class="palette-item p-3 bg-white rounded-md shadow-sm border border-[var(--color-border-light)] flex items-center justify-between" draggable="true" data-type="conditional">
                    <span class="font-medium text-[var(--color-primary-dark)]">Conditional Block</span>
                    <i class="fas fa-grip-vertical text-[var(--color-text-muted)]"></i>
                </div>
            </div>
        </div>

        <!-- Main Canvas -->
        <div class="form-canvas">
            <div class="mb-4">
                <h2 class="text-xl font-semibold mb-2 text-[var(--color-primary-dark)]">Form Canvas</h2>
                <p class="text-sm text-[var(--color-text-muted)]">Drag & drop elements here to build your form.</p>
            </div>

            <div id="form-canvas" class="space-y-4">
                <!-- Initial drop target -->
                <div class="drop-target" data-type="field">
                    Drag & drop elements here
                </div>
            </div>

            <div class="mt-8 p-4 bg-[var(--color-light-gray)] rounded-lg shadow-sm border border-[var(--color-border-light)]">
                <h3 class="text-lg font-semibold mb-3 text-[var(--color-primary-dark)]">Form Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="form-title" class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Form Title</label>
                        <input type="text" id="form-title" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]" placeholder="Enter form title">
                    </div>
                    <div>
                        <label for="form-description" class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Description</label>
                        <textarea id="form-description" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]" rows="3" placeholder="Optional description for the form"></textarea>
                    </div>
                </div>
                <button class="mt-4 bg-[var(--color-primary-blue)] text-[var(--color-white)] px-4 py-2 rounded-lg font-medium hover:bg-opacity-90 transition-colors flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Add Section
                </button>
            </div>
        </div>

        <!-- Logic & Validations Sidebar -->
        <div class="w-80 bg-[var(--color-white)] p-4 border-l border-[var(--color-border-light)] shadow-lg flex flex-col">
            <h2 class="text-lg font-semibold mb-4 text-[var(--color-primary-dark)]">Logic & Validations</h2>

            <div class="mb-6">
                <h3 class="text-md font-medium mb-2 text-[var(--color-text-dark)]">Nested Conditionals</h3>
                <div id="conditional-list" class="space-y-3">
                    <p class="text-sm text-[var(--color-text-muted)]">No conditional blocks yet.</p>
                </div>
                <button id="add-conditional" class="mt-4 bg-[var(--color-light-gray)] text-[var(--color-primary-dark)] px-4 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Add Conditional Block
                </button>
            </div>

            <div class="mb-6">
                <h3 class="text-md font-medium mb-2 text-[var(--color-text-dark)]">Custom Validations</h3>
                <div id="validation-list" class="space-y-3">
                    <p class="text-sm text-[var(--color-text-muted)]">No custom validations yet.</p>
                </div>
                <button id="add-validation" class="mt-4 bg-[var(--color-light-gray)] text-[var(--color-primary-dark)] px-4 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Add Validation Rule
                </button>
            </div>
        </div>
    </div>

    <script>
        const palette = document.getElementById('palette');
        const formCanvas = document.getElementById('form-canvas');
        const conditionalList = document.getElementById('conditional-list');
        const validationList = document.getElementById('validation-list');
        const addConditionalBtn = document.getElementById('add-conditional');
        const addValidationBtn = document.getElementById('add-validation');

        let draggedElement = null;
        let formStructure = []; // Stores the current form structure

        // --- Drag & Drop Logic ---
        palette.addEventListener('dragstart', (e) => {
            draggedElement = e.target;
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', e.target.dataset.type);
        });

        formCanvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            const target = e.target.closest('.drop-target, .form-field');
            if (target) {
                target.classList.add('drag-over');
            }
        });

        formCanvas.addEventListener('dragleave', (e) => {
            e.target.closest('.drop-target, .form-field')?.classList.remove('drag-over');
        });

        formCanvas.addEventListener('drop', (e) => {
            e.preventDefault();
            e.target.closest('.drop-target, .form-field')?.classList.remove('drag-over');

            const type = e.dataTransfer.getData('text/plain');
            const target = e.target.closest('.drop-target, .form-field');

            if (target && type) {
                const fieldId = `field-${Date.now()}`;
                const newField = createFormField(type, fieldId);
                if (target.classList.contains('drop-target')) {
                    target.replaceWith(newField);
                } else if (target.classList.contains('form-field')) {
                    target.after(newField);
                }
                addFieldToStructure(type, fieldId, target.dataset.type === 'conditional' ? true : false);
            }
        });

        formCanvas.addEventListener('dragend', () => {
            draggedElement = null;
        });

        // --- Form Field Creation ---
        function createFormField(type, id, isConditional = false) {
            const fieldDiv = document.createElement('div');
            fieldDiv.id = id;
            fieldDiv.classList.add('form-field', 'relative');
            fieldDiv.dataset.type = type;
            fieldDiv.dataset.id = id;
            fieldDiv.draggable = true;

            let label = '';
            let input = '';
            let validationOptions = '';

            if (type === 'text' || type === 'number' || type === 'email') {
                label = `<label for="${id}" class="block text-sm font-medium text-[var(--color-text-dark)]">Label for ${type}</label>`;
                input = `<input type="${type}" id="${id}" name="${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]" placeholder="Enter value">`;
            } else if (type === 'textarea') {
                label = `<label for="${id}" class="block text-sm font-medium text-[var(--color-text-dark)]">Label for Text Area</label>`;
                input = `<textarea id="${id}" name="${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]" rows="3" placeholder="Enter text"></textarea>`;
            } else if (type === 'select') {
                label = `<label for="${id}" class="block text-sm font-medium text-[var(--color-text-dark)]">Label for Dropdown</label>`;
                input = `
                    <select id="${id}" name="${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]">
                        <option value="">Select an option</option>
                        <option value="option1">Option 1</option>
                        <option value="option2">Option 2</option>
                    </select>
                `;
            } else if (type === 'checkbox') {
                label = `<label class="flex items-center text-sm font-medium text-[var(--color-text-dark)]">
                    <input type="checkbox" id="${id}" name="${id}" class="mr-2 h-4 w-4 text-[var(--color-primary-blue)] border-gray-300 rounded focus:ring-[var(--color-primary-blue)]">
                    Checkbox Label
                </label>`;
                input = '';
            } else if (type === 'radio') {
                label = `<label class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Radio Buttons Label</label>`;
                input = `
                    <div class="flex flex-col space-y-1">
                        <label class="flex items-center">
                            <input type="radio" name="${id}" value="radio1" class="mr-2 h-4 w-4 text-[var(--color-primary-blue)] border-gray-300 focus:ring-[var(--color-primary-blue)]">
                            Radio 1
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="${id}" value="radio2" class="mr-2 h-4 w-4 text-[var(--color-primary-blue)] border-gray-300 focus:ring-[var(--color-primary-blue)]">
                            Radio 2
                        </label>
                    </div>
                `;
            } else if (type === 'conditional') {
                label = `<h3 class="text-md font-semibold mb-2 text-[var(--color-text-dark)]">Conditional Block</h3>`;
                input = `
                    <div class="conditional-logic mb-2">
                        <label for="conditional-field-${id}" class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Field</label>
                        <select id="conditional-field-${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]">
                            <option value="">Select a field</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="conditional-logic mb-2">
                        <label for="conditional-operator-${id}" class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Operator</label>
                        <select id="conditional-operator-${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]">
                            <option value="equals">equals</option>
                            <option value="not-equals">not equals</option>
                            <option value="greater-than">greater than</option>
                            <option value="less-than">less than</option>
                            <option value="contains">contains</option>
                            <option value="not-contains">not contains</option>
                        </select>
                    </div>
                    <div class="conditional-logic">
                        <label for="conditional-value-${id}" class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Value</label>
                        <input type="text" id="conditional-value-${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]" placeholder="Enter value">
                    </div>
                `;
            }

            validationOptions = `
                <div class="conditional-logic mt-3">
                    <label class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Validation Rules</label>
                    <select multiple class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]">
                        <!-- Populated dynamically -->
                        <option value="required">Required</option>
                        <option value="min-length">Min Length</option>
                        <option value="max-length">Max Length</option>
                        <option value="min-value">Min Value</option>
                        <option value="max-value">Max Value</option>
                        <option value="email-format">Email Format</option>
                    </select>
                    <button class="add-validation-btn mt-2 bg-[var(--color-light-gray)] text-[var(--color-primary-dark)] px-3 py-1 rounded-md text-xs hover:bg-gray-200 transition-colors">
                        <i class="fas fa-plus mr-1"></i> Add Rule
                    </button>
                </div>
            `;

            fieldDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-[var(--color-primary-dark)]">${type.replace('-', ' ').toUpperCase()}</span>
                    <div class="flex space-x-2">
                        <button class="remove-field-btn text-[var(--color-text-muted)] hover:text-[var(--color-error)] transition-colors" title="Remove Field">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="copy-field-btn text-[var(--color-text-muted)] hover:text-[var(--color-primary-blue)] transition-colors" title="Copy Field">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="add-field-btn text-[var(--color-text-muted)] hover:text-[var(--color-primary-blue)] transition-colors" title="Add Field Below">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="add-conditional-btn text-[var(--color-text-muted)] hover:text-[var(--color-primary-blue)] transition-colors" title="Add Conditional" data-type="conditional">
                            <i class="fas fa-code-branch"></i>
                        </button>
                    </div>
                </div>
                ${label}
                ${input}
                ${validationOptions}
                <div class="validation-message" id="error-${id}"></div>
            `;

            // Add event listeners for new elements
            fieldDiv.querySelector('.remove-field-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                removeField(fieldDiv);
            });
            fieldDiv.querySelector('.copy-field-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                copyField(fieldDiv);
            });
            fieldDiv.querySelector('.add-field-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                addFieldBelow(fieldDiv, 'text');
            });
            fieldDiv.querySelector('.add-conditional-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                addConditionalBlock(fieldDiv);
            });
            fieldDiv.addEventListener('dragstart', (e) => {
                e.target.classList.add('dragging');
                draggedElement = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', e.target.dataset.id);
            });
            fieldDiv.addEventListener('dragend', () => {
                e.target.classList.remove('dragging');
            });

            return fieldDiv;
        }

        function addFieldToStructure(type, id, isConditional) {
            formStructure.push({ id, type, isConditional });
            if (type === 'conditional') {
                renderConditionalBlocks();
            }
        }

        function removeField(fieldElement) {
            const idToRemove = fieldElement.dataset.id;
            formStructure = formStructure.filter(field => field.id !== idToRemove);
            fieldElement.remove();
            renderConditionalBlocks();
        }

        function copyField(fieldElement) {
            const originalId = fieldElement.dataset.id;
            const originalType = fieldElement.dataset.type;
            const newId = `field-${Date.now()}`;
            const newFieldElement = createFormField(originalType, newId);
            fieldElement.after(newFieldElement);
            addFieldToStructure(originalType, newId);
            renderConditionalBlocks();
        }

        function addFieldBelow(fieldElement, type) {
            const newId = `field-${Date.now()}`;
            const newFieldElement = createFormField(type, newId);
            fieldElement.after(newFieldElement);
            addFieldToStructure(type, newId);
            renderConditionalBlocks();
        }

        function addConditionalBlock(fieldElement) {
            const newId = `conditional-${Date.now()}`;
            const newConditionalBlock = createConditionalBlock(newId, fieldElement.dataset.id);
            fieldElement.after(newConditionalBlock);
            formStructure.push({ id: newId, type: 'conditional', isConditional: true });
            renderConditionalBlocks();
        }

        // --- Conditional Block Creation ---
        function createConditionalBlock(id, targetFieldId) {
            const conditionalDiv = document.createElement('div');
            conditionalDiv.id = id;
            conditionalDiv.classList.add('conditional-block', 'relative');
            conditionalDiv.dataset.type = 'conditional';
            conditionalDiv.dataset.id = id;
            conditionalDiv.draggable = true;

            conditionalDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-[var(--color-primary-dark)]">Conditional Block</span>
                    <div class="flex space-x-2">
                        <button class="remove-conditional-btn text-[var(--color-text-muted)] hover:text-[var(--color-error)] transition-colors" title="Remove Conditional">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="copy-conditional-btn text-[var(--color-text-muted)] hover:text-[var(--color-primary-blue)] transition-colors" title="Copy Conditional">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="add-conditional-field-btn text-[var(--color-text-muted)] hover:text-[var(--color-primary-blue)] transition-colors" title="Add Field Inside">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="conditional-logic mb-2">
                    <label for="conditional-field-${id}" class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Field</label>
                    <select id="conditional-field-${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]">
                        <option value="">Select a field</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="conditional-logic mb-2">
                    <label for="conditional-operator-${id}" class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Operator</label>
                    <select id="conditional-operator-${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]">
                        <option value="equals">equals</option>
                        <option value="not-equals">not equals</option>
                        <option value="greater-than">greater than</option>
                        <option value="less-than">less than</option>
                        <option value="contains">contains</option>
                        <option value="not-contains">not contains</option>
                    </select>
                </div>
                <div class="conditional-logic">
                    <label for="conditional-value-${id}" class="block text-sm font-medium text-[var(--color-text-dark)] mb-1">Value</label>
                    <input type="text" id="conditional-value-${id}" class="w-full p-2 border border-[var(--color-border-light)] rounded-md bg-[var(--color-white)] text-[var(--color-primary-dark)] focus:ring-[var(--color-primary-blue)] focus:border-[var(--color-primary-blue)]" placeholder="Enter value">
                </div>
            `;

            // Populate field options
            const fieldSelect = conditionalDiv.querySelector(`#conditional-field-${id}`);
            formStructure.forEach(field => {
                if (field.type !== 'conditional') { // Don't allow conditional blocks to depend on other conditionals
                    const option = document.createElement('option');
                    option.value = field.id;
                    option.textContent = `Field ${field.id.replace('field-', '')}`;
                    fieldSelect.appendChild(option);
                }
            });

            // Add event listeners for new elements
            conditionalDiv.querySelector('.remove-conditional-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                removeConditionalBlock(conditionalDiv);
            });
            conditionalDiv.querySelector('.copy-conditional-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                copyConditionalBlock(conditionalDiv);
            });
            conditionalDiv.querySelector('.add-conditional-field-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                addFieldInsideConditional(conditionalDiv, 'text');
            });
            conditionalDiv.addEventListener('dragstart', (e) => {
                e.target.classList.add('dragging');
                draggedElement = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', e.target.dataset.id);
            });
            conditionalDiv.addEventListener('dragend', () => {
                e.target.classList.remove('dragging');
            });

            return conditionalDiv;
        }

        function removeConditionalBlock(conditionalElement) {
            const idToRemove = conditionalElement.dataset.id;
            formStructure = formStructure.filter(field => field.id !== idToRemove);
            conditionalElement.remove();
            renderConditionalBlocks();
        }

        function copyConditionalBlock(conditionalElement) {
            const originalId = conditionalElement.dataset.id;
            const newId = `conditional-${Date.now()}`;
            const newConditionalElement = createConditionalBlock(newId, originalId); // Copy target field ID
            conditionalElement.after(newConditionalElement);
            addFieldToStructure('conditional', newId);
            renderConditionalBlocks();
        }

        function addFieldInsideConditional(conditionalElement, type) {
            const newId = `field-${Date.now()}`;
            const newFieldElement = createFormField(type, newId);
            conditionalElement.after(newFieldElement);
            addFieldToStructure(type, newId);
            renderConditionalBlocks();
        }

        // --- Validation Logic ---
        function addValidationRule() {
            const ruleName = prompt("Enter validation rule name (e.g., 'min-length')");
            if (ruleName) {
                const ruleDescription = prompt("Enter validation rule description");
                if (ruleDescription) {
                    const ruleDiv = document.createElement('div');
                    ruleDiv.classList.add('validation-rule', 'p-3', 'bg-[var(--color-accent-bg)]', 'rounded-md', 'border', 'border-[var(--color-accent-border)]');
                    ruleDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-[var(--color-primary-dark)]">${ruleName}</span>
                            <button class="remove-validation-btn text-[var(--color-text-muted)] hover:text-[var(--color-error)] transition-colors" title="Remove Rule">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <p class="text-sm text-[var(--color-text-muted)] mt-1">${ruleDescription}</p>
                    `;
                    validationList.appendChild(ruleDiv);
                    ruleDiv.querySelector('.remove-validation-btn').addEventListener('click', () => {
                        ruleDiv.remove();
                    });
                }
            }
        }

        // --- Dynamic Rendering of Conditional Blocks ---
        function renderConditionalBlocks() {
            conditionalList.innerHTML = '';
            if (formStructure.filter(field => field.isConditional).length === 0) {
                conditionalList.innerHTML = '<p class="text-sm text-[var(--color-text-muted)]">No conditional blocks yet.</p>';
                return;
            }

            formStructure.filter(field => field.isConditional).forEach(conditional => {
                const conditionalDiv = createConditionalBlock(conditional.id, ''); // No specific target field for root conditionals
                conditionalList.appendChild(conditionalDiv);
            });
        }

        // --- Event Listeners ---
        addConditionalBtn.addEventListener('click', addValidationRule);
        addValidationBtn.addEventListener('click', addValidationRule);

        formCanvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const target = e.target.closest('.form-field, .conditional-block');
            if (target && target !== draggedElement) {
                target.classList.add('drag-over');
            }
        });

        formCanvas.addEventListener('dragleave', (e) => {
            e.target.closest('.form-field, .conditional-block')?.classList.remove('drag-over');
        });

        formCanvas.addEventListener('drop', (e) => {
            e.preventDefault();
            e.target.closest('.form-field, .conditional-block')?.classList.remove('drag-over');

            const droppedId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(droppedId);
            const targetElement = e.target.closest('.form-field, .conditional-block');

            if (draggedElement && targetElement && draggedElement !== targetElement) {
                // Find the original position of the dragged element
                const originalParent = draggedElement.parentNode;
                const originalIndex = Array.from(originalParent.children).indexOf(draggedElement);

                // Remove from original parent
                draggedElement.remove();

                // Insert after the target element
                targetElement.after(draggedElement);

                // Update formStructure order
                const draggedData = formStructure.find(f => f.id === droppedId);
                if (draggedData) {
                    const targetIndex = formStructure.findIndex(f => f.id === targetElement.dataset.id);
                    if (targetIndex !== -1) {
                        formStructure.splice(originalIndex, 1);
                        formStructure.splice(targetIndex + 1, 0, draggedData);
                    }
                }
            }
        });

        // Initial render
        renderConditionalBlocks();

        // --- Basic Validation Example (Client-side) ---
        formCanvas.addEventListener('input', (e) => {
            const fieldElement = e.target.closest('.form-field');
            if (fieldElement) {
                const fieldId = fieldElement.dataset.id;
                const validationMessage = document.getElementById(`error-${fieldId}`);
                validationMessage.textContent = ''; // Clear previous message

                const inputElement = fieldElement.querySelector('input, select, textarea');
                if (!inputElement) return;

                const required = fieldElement.querySelector('.conditional-logic select')?.value === 'required';
                const minLength = parseInt(fieldElement.querySelector('.conditional-logic select')?.value === 'min-length' ? fieldElement.querySelector('.conditional-logic input')?.value : 0);
                const maxLength = parseInt(fieldElement.querySelector('.conditional-logic select')?.value === 'max-length' ? fieldElement.querySelector('.conditional-logic input')?.value : 0);
                const minValue = parseInt(fieldElement.querySelector('.conditional-logic select')?.value === 'min-value' ? fieldElement.querySelector('.conditional-logic input')?.value : 0);
                const maxValue = parseInt(fieldElement.querySelector('.conditional-logic select')?.value === 'max-value' ? fieldElement.querySelector('.conditional-logic input')?.value : 0);
                const emailFormat = fieldElement.querySelector('.conditional-logic select')?.value === 'email-format';

                let isValid = true;
                let errorMessage = '';

                if (required && !inputElement.value.trim()) {
                    isValid = false;
                    errorMessage = 'This field is required.';
                }
                if (inputElement.type === 'text' || inputElement.type === 'textarea' || inputElement.type === 'email') {
                    if (minLength > 0 && inputElement.value.length < minLength) {
                        isValid = false;
                        errorMessage = `Minimum length is ${minLength} characters.`;
                    }
                    if (maxLength > 0 && inputElement.value.length > maxLength) {
                        isValid = false;
                        errorMessage = `Maximum length is ${maxLength} characters.`;
                    }
                    if (emailFormat && inputElement.type === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inputElement.value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid email address.';
                    }
                } else if (inputElement.type === 'number') {
                    if (minValue > 0 && parseFloat(inputElement.value) < minValue) {
                        isValid = false;
                        errorMessage = `Value must be at least ${minValue}.`;
                    }
                    if (maxValue > 0 && parseFloat(inputElement.value) > maxValue) {
                        isValid = false;
                        errorMessage = `Value must be at most ${maxValue}.`;
                    }
                }

                if (!isValid) {
                    validationMessage.textContent = errorMessage;
                    validationMessage.classList.add('validation-message');
                } else {
                    validationMessage.textContent = '';
                }
            }
        });
    </script>
</body>
</html>