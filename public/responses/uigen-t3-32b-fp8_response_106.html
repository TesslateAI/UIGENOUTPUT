<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Low-Code Workflow Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --color-white: rgb(255, 255, 255);
            --color-bg-dark: rgb(10, 10, 12);
            --color-text-muted: rgb(171, 171, 171);
            --color-text-light: var(--color-white);
            --color-primary: rgb(0, 153, 255);
            --color-primary-light-bg: rgba(0, 153, 255, 0.1);
            --color-border-dark: rgb(36, 36, 36);
            --color-card-bg: rgb(18, 18, 20);
            --color-accent-glow: rgb(70, 200, 255); /* Lighter blue for glow */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden; /* Prevent body scroll, workflow canvas will scroll */
        }

        /* Custom scrollbar for canvas */
        .workflow-canvas::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .workflow-canvas::-webkit-scrollbar-track {
            background: var(--color-card-bg);
        }
        .workflow-canvas::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: 4px;
        }
        .workflow-canvas::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-light-bg);
        }

        .node {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: grab;
            position: absolute; /* Position nodes absolutely within the canvas */
            min-width: 200px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none; /* Prevent text selection when dragging */
        }

        .node.dragging {
            opacity: 0.7;
            border: 2px dashed var(--color-primary);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3), 0 0 0 4px var(--color-primary-light-bg);
        }

        .node-handle {
            width: 12px;
            height: 12px;
            background-color: var(--color-primary);
            border: 2px solid var(--color-white);
            border-radius: 50%;
            position: absolute;
            z-index: 10;
        }

        .node-handle.left {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .node-handle.right {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .node-handle.top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .node-handle.bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background-color: var(--color-primary);
            transform-origin: 0 0;
            z-index: 5;
            pointer-events: none; /* Allow clicks to pass through */
        }

        .connection-line::before, .connection-line::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--color-primary);
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .connection-line::before { /* Start point */
            top: -4px;
            left: -4px;
        }
        .connection-line::after { /* End point */
            bottom: -4px;
            right: -4px;
        }

        .branch-handle {
            width: 8px;
            height: 8px;
            background-color: var(--color-primary);
            border: 1px solid var(--color-white);
            border-radius: 50%;
            position: absolute;
            z-index: 10;
            cursor: pointer;
        }

        .branch-handle.top-left {
            top: 10px;
            left: 10px;
        }

        .branch-handle.top-right {
            top: 10px;
            right: 10px;
        }

        .branch-handle.bottom-left {
            bottom: 10px;
            left: 10px;
        }

        .branch-handle.bottom-right {
            bottom: 10px;
            right: 10px;
        }

        .branch-line {
            position: absolute;
            height: 2px;
            background-color: var(--color-primary);
            transform-origin: 0 0;
            z-index: 5;
            pointer-events: none;
        }

        .branch-line::before, .branch-line::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--color-primary);
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .branch-line::before { /* Start point */
            top: -4px;
            left: -4px;
        }
        .branch-line::after { /* End point */
            bottom: -4px;
            right: -4px;
        }

        .branch-connector {
            width: 12px;
            height: 12px;
            background-color: var(--color-primary);
            border: 2px solid var(--color-white);
            border-radius: 50%;
            position: absolute;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--color-white);
            cursor: pointer;
        }
        .branch-connector:hover {
            background-color: var(--color-accent-glow);
        }

        .node-header {
            background-color: var(--color-primary);
            color: var(--color-white);
            padding: 10px 15px;
            font-weight: 600;
            border-top-left-radius: 7px;
            border-top-right-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .node-content {
            padding: 15px;
            flex-grow: 1;
        }

        .node-footer {
            background-color: var(--color-card-bg);
            border-top: 1px solid var(--color-border-dark);
            padding: 10px 15px;
            border-bottom-left-radius: 7px;
            border-bottom-right-radius: 7px;
            display: flex;
            justify-content: flex-end;
        }

        .node-actions button {
            background: none;
            border: none;
            color: var(--color-text-light);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .node-actions button:hover {
            background-color: var(--color-primary-light-bg);
        }

        /* Sidebar styles */
        .sidebar {
            background-color: var(--color-card-bg);
            border-right: 1px solid var(--color-border-dark);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar-category {
            margin-bottom: 20px;
        }

        .sidebar-category h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--color-text-light);
        }

        .sidebar-item {
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border-dark);
            padding: 12px;
            border-radius: 8px;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .sidebar-item:hover {
            background-color: var(--color-primary-light-bg);
            border-color: var(--color-primary);
        }

        .sidebar-item i {
            font-size: 1.25rem;
            color: var(--color-primary);
        }

        .sidebar-item span {
            font-size: 0.95rem;
            color: var(--color-text-light);
            flex-grow: 1;
        }

        /* Modal for editing node properties */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--color-card-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--color-border-dark);
            padding-bottom: 15px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border-dark);
            border-radius: 6px;
            color: var(--color-text-light);
            margin-bottom: 15px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .input-field:focus {
            border-color: var(--color-primary);
        }

        .select-field {
            width: 100%;
            padding: 10px;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border-dark);
            border-radius: 6px;
            color: var(--color-text-light);
            margin-bottom: 15px;
            outline: none;
            transition: border-color 0.2s ease;
            appearance: none; /* Remove default arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23a2a2a2'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .select-field:focus {
            border-color: var(--color-primary);
        }

        .select-field option {
            background-color: var(--color-card-bg);
            color: var(--color-text-light);
        }

        .add-condition-btn {
            background-color: var(--color-primary);
            color: var(--color-white);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .add-condition-btn:hover {
            background-color: var(--color-accent-glow);
        }

        .condition-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border-dark);
            padding: 10px;
            border-radius: 6px;
        }

        .condition-row input[type="text"] {
            flex-grow: 1;
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border-dark);
            padding: 8px;
            border-radius: 4px;
            color: var(--color-text-light);
        }

        .condition-row button.remove-condition {
            background-color: var(--color-primary-light-bg);
            color: var(--color-primary);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .condition-row button.remove-condition:hover {
            background-color: var(--color-primary);
            color: var(--color-white);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                padding: 15px;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                border-right: none;
                border-bottom: 1px solid var(--color-border-dark);
            }
            .sidebar-category {
                flex-shrink: 0;
                width: 150px; /* Adjust width as needed */
                margin-bottom: 0;
            }
            .sidebar-item {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            .sidebar-item i {
                font-size: 1rem;
            }
            .sidebar-item span {
                font-size: 0.8rem;
            }

            .workflow-builder {
                flex-direction: column;
                height: calc(100vh - 80px); /* Adjust based on header/footer */
            }
            .workflow-canvas {
                flex-grow: 1;
                width: 100%;
                height: 100%;
            }
            .node {
                min-width: 180px;
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Top Bar / Header -->
    <header class="bg-[var(--color-card-bg)] border-b border-[var(--color-border-dark)] p-4 flex justify-between items-center z-20">
        <h1 class="text-2xl font-bold text-[var(--color-text-light)]">Workflow Builder</h1>
        <div class="flex items-center space-x-4">
            <button class="bg-[var(--color-primary)] text-white px-5 py-2 rounded-lg font-medium hover:bg-[var(--color-accent-glow)] transition-colors">
                <i class="fas fa-play mr-2"></i>Run Workflow
            </button>
            <button id="save-workflow-btn" class="bg-[var(--color-primary-light-bg)] text-[var(--color-primary)] px-5 py-2 rounded-lg font-medium hover:bg-[var(--color-primary)] hover:text-white transition-colors">
                <i class="fas fa-save mr-2"></i>Save
            </button>
        </div>
    </header>

    <!-- Main Builder Area -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar for Components -->
        <aside class="sidebar w-64 lg:w-72 shrink-0">
            <div class="sidebar-category">
                <h3>Triggers</h3>
                <div class="sidebar-item" data-type="trigger" data-name="New Email">
                    <i class="fas fa-envelope"></i>
                    <span>New Email</span>
                </div>
                <div class="sidebar-item" data-type="trigger" data-name="New Form Submission">
                    <i class="fas fa-file-alt"></i>
                    <span>New Form Submission</span>
                </div>
                <div class="sidebar-item" data-type="trigger" data-name="Schedule">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Schedule</span>
                </div>
            </div>
            <div class="sidebar-category">
                <h3>Actions</h3>
                <div class="sidebar-item" data-type="action" data-name="Send Slack Message">
                    <i class="fab fa-slack"></i>
                    <span>Send Slack Message</span>
                </div>
                <div class="sidebar-item" data-type="action" data-name="Create Google Doc">
                    <i class="fab fa-google-drive"></i>
                    <span>Create Google Doc</span>
                </div>
                <div class="sidebar-item" data-type="action" data-name="Update CRM Record">
                    <i class="fas fa-database"></i>
                    <span>Update CRM Record</span>
                </div>
            </div>
            <div class="sidebar-category">
                <h3>Utilities</h3>
                <div class="sidebar-item" data-type="branch" data-name="If/Else">
                    <i class="fas fa-code-branch"></i>
                    <span>If/Else</span>
                </div>
                <div class="sidebar-item" data-type="delay" data-name="Delay">
                    <i class="fas fa-hourglass-half"></i>
                    <span>Delay</span>
                </div>
            </div>
        </aside>

        <!-- Workflow Canvas -->
        <div id="workflow-canvas" class="workflow-canvas flex-1 bg-[var(--color-bg-dark)] relative overflow-scroll p-8">
            <!-- Nodes will be appended here by JavaScript -->
        </div>
    </div>

    <!-- Node Properties Modal -->
    <div id="node-properties-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="text-xl font-semibold">Node Properties</h2>
                <button id="close-modal-btn" class="text-[var(--color-text-muted)] hover:text-[var(--color-text-light)] text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="node-name-input" class="input-field" placeholder="Node Name">
                
                <div id="trigger-settings" class="hidden">
                    <label for="trigger-type" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Trigger Type</label>
                    <select id="trigger-type" class="select-field">
                        <option value="email">New Email</option>
                        <option value="form">New Form Submission</option>
                        <option value="schedule">Schedule</option>
                    </select>
                    <div id="trigger-email-settings" class="hidden">
                        <label for="email-address" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Email Address</label>
                        <input type="email" id="email-address" class="input-field" placeholder="your@example.com">
                    </div>
                    <div id="trigger-schedule-settings" class="hidden">
                        <label for="schedule-time" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Schedule Time (HH:MM)</label>
                        <input type="time" id="schedule-time" class="input-field">
                        <label for="schedule-frequency" class="block text-sm font-medium text-[var(--color-text-light)] mb-2 mt-3">Frequency</label>
                        <select id="schedule-frequency" class="select-field">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>

                <div id="action-settings" class="hidden">
                    <label for="action-type" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Action Type</label>
                    <select id="action-type" class="select-field">
                        <option value="slack">Send Slack Message</option>
                        <option value="google-doc">Create Google Doc</option>
                        <option value="crm">Update CRM Record</option>
                    </select>
                    <div id="action-slack-settings" class="hidden">
                        <label for="slack-channel" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Slack Channel</label>
                        <input type="text" id="slack-channel" class="input-field" placeholder="#general">
                        <label for="slack-message" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Message Content</label>
                        <textarea id="slack-message" class="input-field h-24 resize-y"></textarea>
                    </div>
                    <div id="action-google-doc-settings" class="hidden">
                        <label for="google-doc-title" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Document Title</label>
                        <input type="text" id="google-doc-title" class="input-field" placeholder="My New Document">
                        <label for="google-doc-content" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Content (optional)</label>
                        <textarea id="google-doc-content" class="input-field h-24 resize-y"></textarea>
                    </div>
                    <div id="action-crm-settings" class="hidden">
                        <label for="crm-record-id" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Record ID</label>
                        <input type="text" id="crm-record-id" class="input-field" placeholder="12345">
                        <label for="crm-field" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Field to Update</label>
                        <input type="text" id="crm-field" class="input-field" placeholder="Status">
                        <label for="crm-value" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">New Value</label>
                        <input type="text" id="crm-value" class="input-field" placeholder="Completed">
                    </div>
                </div>

                <div id="branch-settings" class="hidden">
                    <label for="branch-condition-field" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Condition Field</label>
                    <input type="text" id="branch-condition-field" class="input-field" placeholder="e.g., 'Email Subject'">
                    <label for="branch-condition-operator" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Operator</label>
                    <select id="branch-condition-operator" class="select-field">
                        <option value="contains">contains</option>
                        <option value="equals">equals</option>
                        <option value="greaterThan">is greater than</option>
                        <option value="lessThan">is less than</option>
                    </select>
                    <label for="branch-condition-value" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Value</label>
                    <input type="text" id="branch-condition-value" class="input-field" placeholder="e.g., 'Urgent'">
                    <button id="add-another-condition-btn" class="add-condition-btn mt-4">Add Another Condition</button>
                    <div id="additional-conditions-container" class="mt-4"></div>
                </div>

                <div id="delay-settings" class="hidden">
                    <label for="delay-duration" class="block text-sm font-medium text-[var(--color-text-light)] mb-2">Delay Duration (seconds)</label>
                    <input type="number" id="delay-duration" class="input-field" placeholder="e.g., 30">
                </div>
            </div>
            <div class="modal-footer">
                <button id="delete-node-btn" class="bg-red-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i>Delete Node
                </button>
                <button id="save-node-btn" class="bg-[var(--color-primary)] text-white px-5 py-2 rounded-lg font-medium hover:bg-[var(--color-accent-glow)] transition-colors">
                    <i class="fas fa-check mr-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        const workflowCanvas = document.getElementById('workflow-canvas');
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const nodePropertiesModal = document.getElementById('node-properties-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveNodeBtn = document.getElementById('save-node-btn');
        const deleteNodeBtn = document.getElementById('delete-node-btn');
        const nodeNameInput = document.getElementById('node-name-input');

        let currentDraggedNode = null;
        let currentConnectingNode = null; // The node whose handle is being dragged
        let currentConnectionLine = null;
        let currentBranchLine = null;
        let currentNodeBeingEdited = null; // Store the node currently being edited in the modal

        const triggerSettings = document.getElementById('trigger-settings');
        const actionSettings = document.getElementById('action-settings');
        const branchSettings = document.getElementById('branch-settings');
        const delaySettings = document.getElementById('delay-settings');

        const triggerTypeSelect = document.getElementById('trigger-type');
        const triggerEmailSettings = document.getElementById('trigger-email-settings');
        const triggerScheduleSettings = document.getElementById('trigger-schedule-settings');

        const actionTypeSelect = document.getElementById('action-type');
        const actionSlackSettings = document.getElementById('action-slack-settings');
        const actionGoogleDocSettings = document.getElementById('action-google-doc-settings');
        const actionCrmSettings = document.getElementById('action-crm-settings');

        const branchConditionOperatorSelect = document.getElementById('branch-condition-operator');
        const addAnotherConditionBtn = document.getElementById('add-another-condition-btn');
        const additionalConditionsContainer = document.getElementById('additional-conditions-container');

        const saveWorkflowBtn = document.getElementById('save-workflow-btn');

        // --- Node Data Structure ---
        let workflowData = JSON.parse(localStorage.getItem('workflowData')) || {
            nodes: [],
            connections: [],
            branches: [] // For branching logic, we'll store the parent node ID and condition
        };

        function saveWorkflowToLocalStorage() {
            localStorage.setItem('workflowData', JSON.stringify(workflowData));
            console.log('Workflow saved to localStorage:', workflowData);
        }

        function loadWorkflowFromLocalStorage() {
            const storedData = JSON.parse(localStorage.getItem('workflowData'));
            if (storedData) {
                workflowData = storedData;
                renderWorkflow();
            }
        }

        // --- Node Rendering and Management ---
        function createNodeElement(node) {
            const nodeEl = document.createElement('div');
            nodeEl.classList.add('node');
            nodeEl.style.left = `${node.x}px`;
            nodeEl.style.top = `${node.y}px`;
            nodeEl.dataset.id = node.id;
            nodeEl.dataset.type = node.type;

            nodeEl.innerHTML = `
                <div class="node-header">
                    <span>${node.type.charAt(0).toUpperCase() + node.type.slice(1)}: ${node.name || node.type}</span>
                    <button class="edit-node-btn text-[var(--color-text-muted)] hover:text-[var(--color-text-light)] text-lg">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div class="node-content">
                    <p class="text-sm text-[var(--color-text-muted)]">${node.description || 'Configure this node.'}</p>
                    <div class="mt-4">
                        <label for="node-input" class="block text-xs text-[var(--color-text-light)] mb-1">Input (example)</label>
                        <input type="text" value="${node.input || ''}" class="w-full bg-[var(--color-bg-dark)] border border-[var(--color-border-dark)] rounded-md p-2 text-sm text-[var(--color-text-light)]">
                    </div>
                </div>
                <div class="node-footer">
                    <div class="node-actions flex space-x-2">
                        <button class="remove-node-btn text-red-400 hover:bg-red-700 p-2 rounded-md" title="Remove Node">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            // Add handles based on node type
            if (node.type === 'trigger') {
                nodeEl.innerHTML += `<div class="node-handle right"></div>`;
            } else if (node.type === 'action') {
                nodeEl.innerHTML += `<div class="node-handle left"></div>`;
            } else if (node.type === 'branch') {
                nodeEl.innerHTML += `
                    <div class="node-handle top-left"></div>
                    <div class="node-handle top-right"></div>
                    <div class="node-handle bottom-left"></div>
                    <div class="node-handle bottom-right"></div>
                `;
            }

            // Add event listeners for drag, edit, remove
            nodeEl.addEventListener('mousedown', (e) => handleNodeDragStart(e, nodeEl));
            nodeEl.querySelector('.edit-node-btn').addEventListener('click', () => openNodeProperties(nodeEl));
            nodeEl.querySelector('.remove-node-btn').addEventListener('click', () => removeNode(nodeEl.dataset.id));

            // Add event listeners for handles
            nodeEl.querySelectorAll('.node-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => handleHandleDragStart(e, nodeEl, handle));
            });

            // Add branch connectors for branch nodes
            if (node.type === 'branch') {
                const connectorTop = document.createElement('div');
                connectorTop.classList.add('branch-connector', 'top-left');
                connectorTop.innerHTML = '<i class="fas fa-code-branch"></i>';
                connectorTop.style.left = '10px'; // Adjust as needed
                connectorTop.style.top = '10px';
                connectorTop.dataset.branchId = `${node.id}-top`;
                nodeEl.appendChild(connectorTop);
                connectorTop.addEventListener('click', () => createBranch(nodeEl, 'top-left'));

                const connectorBottom = document.createElement('div');
                connectorBottom.classList.add('branch-connector', 'bottom-right');
                connectorBottom.innerHTML = '<i class="fas fa-code-branch"></i>';
                connectorBottom.style.right = '10px';
                connectorBottom.style.bottom = '10px';
                connectorBottom.dataset.branchId = `${node.id}-bottom`;
                nodeEl.appendChild(connectorBottom);
                connectorBottom.addEventListener('click', () => createBranch(nodeEl, 'bottom-right'));
            }

            return nodeEl;
        }

        function renderWorkflow() {
            workflowCanvas.innerHTML = ''; // Clear canvas
            workflowData.nodes.forEach(node => {
                workflowCanvas.appendChild(createNodeElement(node));
            });
            drawConnections();
            drawBranches();
        }

        function addNode(type, name, description, x = 100, y = 100, input = '') {
            const newNode = {
                id: Date.now().toString(),
                type,
                name,
                description,
                x,
                y,
                input
            };
            workflowData.nodes.push(newNode);
            saveWorkflowToLocalStorage();
            renderWorkflow();
        }

        function removeNode(nodeId) {
            workflowData.nodes = workflowData.nodes.filter(node => node.id !== nodeId);
            workflowData.connections = workflowData.connections.filter(conn =>
                conn.fromId !== nodeId && conn.toId !== nodeId
            );
            workflowData.branches = workflowData.branches.filter(branch =>
                branch.parentId !== nodeId
            );
            saveWorkflowToLocalStorage();
            renderWorkflow();
        }

        // --- Drag and Drop ---
        let isDraggingCanvas = false;
        let canvasStartX, canvasStartY;
        let currentScrollX, currentScrollY;

        workflowCanvas.addEventListener('mousedown', (e) => {
            if (e.target === workflowCanvas || e.target.closest('.node') === null) {
                isDraggingCanvas = true;
                canvasStartX = e.clientX - workflowCanvas.scrollLeft;
                canvasStartY = e.clientY - workflowCanvas.scrollTop;
                currentScrollX = workflowCanvas.scrollLeft;
                currentScrollY = workflowCanvas.scrollTop;
                workflowCanvas.style.cursor = 'grabbing';
            }
        });

        workflowCanvas.addEventListener('mousemove', (e) => {
            if (isDraggingCanvas) {
                workflowCanvas.scrollLeft = canvasStartX - e.clientX;
                workflowCanvas.scrollTop = canvasStartY - e.clientY;
            }
        });

        workflowCanvas.addEventListener('mouseup', () => {
            isDraggingCanvas = false;
            workflowCanvas.style.cursor = 'default';
        });

        function handleNodeDragStart(e, nodeEl) {
            if (e.target.classList.contains('node-handle') || e.target.classList.contains('node-actions') || e.target.classList.contains('edit-node-btn')) {
                return; // Don't drag the node if clicking on a handle or action button
            }
            currentDraggedNode = nodeEl;
            nodeEl.classList.add('dragging');
            workflowCanvas.style.cursor = 'grabbing';
            
            const nodeRect = nodeEl.getBoundingClientRect();
            const canvasRect = workflowCanvas.getBoundingClientRect();

            let startX = e.clientX - nodeRect.left;
            let startY = e.clientY - nodeRect.top;

            const onMouseMove = (e) => {
                let newX = e.clientX - canvasRect.left - startX;
                let newY = e.clientY - canvasRect.top - startY;

                // Constrain node within canvas bounds
                newX = Math.max(0, Math.min(newX, workflowCanvas.offsetWidth - nodeRect.width));
                newY = Math.max(0, Math.min(newY, workflowCanvas.offsetHeight - nodeRect.height));

                nodeEl.style.left = `${newX}px`;
                nodeEl.style.top = `${newY}px`;

                // Update node data
                const nodeId = nodeEl.dataset.id;
                workflowData.nodes = workflowData.nodes.map(node =>
                    node.id === nodeId ? { ...node, x: newX, y: newY } : node
                );
            };

            const onMouseUp = () => {
                nodeEl.classList.remove('dragging');
                workflowCanvas.style.cursor = 'default';
                currentDraggedNode = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // --- Connections ---
        function handleHandleDragStart(e, nodeEl, handleEl) {
            e.preventDefault(); // Prevent text selection
            currentConnectingNode = nodeEl;
            currentConnectionLine = document.createElement('div');
            currentConnectionLine.classList.add('connection-line');
            workflowCanvas.appendChild(currentConnectionLine);

            const startCoords = handleEl.getBoundingClientRect();
            const canvasCoords = workflowCanvas.getBoundingClientRect();

            const startX = startCoords.left - canvasCoords.left + startCoords.width / 2;
            const startY = startCoords.top - canvasCoords.top + startCoords.height / 2;

            currentConnectionLine.style.left = `${startX}px`;
            currentConnectionLine.style.top = `${startY}px`;
            currentConnectionLine.style.width = '0px';
            currentConnectionLine.style.height = '0px';

            const onMouseMove = (e) => {
                const currentX = e.clientX - canvasCoords.left;
                const currentY = e.clientY - canvasCoords.top;

                // Calculate the distance from the start point to the current mouse position
                const dx = currentX - startX;
                const dy = currentY - startY;

                // Set the line's width and height based on the distance
                currentConnectionLine.style.width = `${Math.sqrt(dx * dx + dy * dy)}px`;

                // Rotate the line to match the angle of the connection
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                currentConnectionLine.style.transform = `rotate(${angle}deg)`;

                // Position the line so it starts at the handle
                currentConnectionLine.style.left = `${startX}px`;
                currentConnectionLine.style.top = `${startY}px`;

                // Adjust the line's end point to be at the mouse cursor
                currentConnectionLine.style.height = '0px'; // Make it a line
                currentConnectionLine.style.transformOrigin = '0 0'; // Rotate from start

                // For the end point circle
                currentConnectionLine.style.setProperty('--line-end-x', `${currentX}px`);
                currentConnectionLine.style.setProperty('--line-end-y', `${currentY}px`);
            };

            const onMouseUp = (e) => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);

                if (currentConnectionLine) {
                    workflowCanvas.removeChild(currentConnectionLine);
                    currentConnectionLine = null;
                }

                const targetHandle = e.target.closest('.node-handle');
                if (targetHandle && targetHandle !== handleEl) {
                    const targetNodeEl = targetHandle.closest('.node');
                    if (targetNodeEl && targetNodeEl.dataset.id !== currentConnectingNode.dataset.id) {
                        const fromId = currentConnectingNode.dataset.id;
                        const toId = targetNodeEl.dataset.id;
                        const fromHandleType = handleEl.classList.contains('left') ? 'left' : 'right';
                        const toHandleType = targetHandle.classList.contains('left') ? 'left' : 'right';

                        // Prevent connecting action to trigger, or trigger to action (basic logic)
                        const fromNode = workflowData.nodes.find(n => n.id === fromId);
                        const toNode = workflowData.nodes.find(n => n.id === toId);

                        if ((fromNode.type === 'trigger' && toNode.type === 'action') ||
                            (fromNode.type === 'action' && toNode.type === 'action') ||
                            (fromNode.type === 'branch' && toNode.type === 'action')) {
                            addConnection(fromId, toId);
                        } else {
                            console.warn('Invalid connection type:', fromNode.type, 'to', toNode.type);
                        }
                    }
                }
                currentConnectingNode = null;
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function addConnection(fromId, toId) {
            // Check for existing connection to prevent duplicates
            if (workflowData.connections.some(conn => conn.fromId === fromId && conn.toId === toId)) {
                return;
            }
            workflowData.connections.push({ fromId, toId });
            saveWorkflowToLocalStorage();
            drawConnections();
        }

        function drawConnections() {
            workflowData.connections.forEach(conn => {
                const fromNodeEl = workflowCanvas.querySelector(`[data-id="${conn.fromId}"]`);
                const toNodeEl = workflowCanvas.querySelector(`[data-id="${conn.toId}"]`);

                if (fromNodeEl && toNodeEl) {
                    const fromHandle = fromNodeEl.querySelector('.node-handle.right');
                    const toHandle = toNodeEl.querySelector('.node-handle.left');

                    if (fromHandle && toHandle) {
                        const startRect = fromHandle.getBoundingClientRect();
                        const endRect = toHandle.getBoundingClientRect();
                        const canvasRect = workflowCanvas.getBoundingClientRect();

                        const startX = startRect.left - canvasRect.left + startRect.width / 2;
                        const startY = startRect.top - canvasRect.top + startRect.height / 2;
                        const endX = endRect.left - canvasRect.left + endRect.width / 2;
                        const endY = endRect.top - canvasRect.top + endRect.height / 2;

                        const dx = endX - startX;
                        const dy = endY - startY;
                        const length = Math.sqrt(dx * dx + dy * dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                        const connectionLine = document.createElement('div');
                        connectionLine.classList.add('connection-line');
                        connectionLine.style.left = `${startX}px`;
                        connectionLine.style.top = `${startY}px`;
                        connectionLine.style.width = `${length}px`;
                        connectionLine.style.transform = `rotate(${angle}deg)`;
                        connectionLine.style.transformOrigin = '0 0'; // Rotate from start
                        workflowCanvas.appendChild(connectionLine);
                    }
                }
            });
        }

        // --- Branching Logic ---
        function createBranch(parentNodeEl, branchPoint) {
            const parentId = parentNodeEl.dataset.id;
            const branchId = `${parentId}-${branchPoint}`;

            // Check if this branch already exists
            if (workflowData.branches.some(branch => branch.parentId === parentId && branch.branchId === branchId)) {
                return;
            }

            // Add the branch to the data
            workflowData.branches.push({ parentId, branchId });

            // Create a new node for the branch path
            const newBranchNode = {
                id: Date.now().toString(),
                type: 'action', // Branch paths typically lead to an action
                name: `Branch Action (${branchPoint})`,
                description: 'Action executed on branch path',
                x: parseInt(parentNodeEl.style.left) + 250, // Position to the right
                y: parseInt(parentNodeEl.style.top) + 50,  // Adjust vertical position
                input: ''
            };
            workflowData.nodes.push(newBranchNode);
            saveWorkflowToLocalStorage();

            renderWorkflow(); // Re-render to add the new node and draw connections
        }

        function drawBranches() {
            workflowData.branches.forEach(branch => {
                const parentNodeEl = workflowCanvas.querySelector(`[data-id="${branch.parentId}"]`);
                const branchNodeEl = workflowCanvas.querySelector(`[data-id="${branch.branchId}"]`); // Assuming branchId is the new node ID

                if (parentNodeEl && branchNodeEl) {
                    // Get the branch handle (e.g., top-left, bottom-right)
                    const branchHandle = parentNodeEl.querySelector(`.node-handle.${branch.branchId.split('-')[1]}`); // e.g., .node-handle.top-left
                    if (!branchHandle) return;

                    const startRect = branchHandle.getBoundingClientRect();
                    const endRect = branchNodeEl.querySelector('.node-handle.left').getBoundingClientRect();
                    const canvasRect = workflowCanvas.getBoundingClientRect();

                    const startX = startRect.left - canvasRect.left + startRect.width / 2;
                    const startY = startRect.top - canvasRect.top + startRect.height / 2;
                    const endX = endRect.left - canvasRect.left + endRect.width / 2;
                    const endY = endRect.top - canvasRect.top + endRect.height / 2;

                    const dx = endX - startX;
                    const dy = endY - startY;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                    const branchLine = document.createElement('div');
                    branchLine.classList.add('branch-line');
                    branchLine.style.left = `${startX}px`;
                    branchLine.style.top = `${startY}px`;
                    branchLine.style.width = `${length}px`;
                    branchLine.style.transform = `rotate(${angle}deg)`;
                    branchLine.style.transformOrigin = '0 0';
                    workflowCanvas.appendChild(branchLine);
                }
            });
        }

        // --- Node Properties Modal ---
        function openNodeProperties(nodeEl) {
            currentNodeBeingEdited = nodeEl;
            const nodeId = nodeEl.dataset.id;
            const nodeData = workflowData.nodes.find(n => n.id === nodeId);

            if (!nodeData) return;

            nodeNameInput.value = nodeData.name;
            triggerSettings.classList.add('hidden');
            actionSettings.classList.add('hidden');
            branchSettings.classList.add('hidden');
            delaySettings.classList.add('hidden');

            document.getElementById('modal-title').textContent = `Edit ${nodeData.type.charAt(0).toUpperCase() + nodeData.type.slice(1)}: ${nodeData.name}`;

            if (nodeData.type === 'trigger') {
                triggerSettings.classList.remove('hidden');
                triggerTypeSelect.value = nodeData.input || 'email'; // Assuming input field stores trigger type
                triggerEmailSettings.classList.toggle('hidden', triggerTypeSelect.value !== 'email');
                triggerScheduleSettings.classList.toggle('hidden', triggerTypeSelect.value !== 'schedule');
                document.getElementById('email-address').value = nodeData.emailAddress || '';
                document.getElementById('schedule-time').value = nodeData.scheduleTime || '';
                document.getElementById('schedule-frequency').value = nodeData.scheduleFrequency || 'daily';
            } else if (nodeData.type === 'action') {
                actionSettings.classList.remove('hidden');
                actionTypeSelect.value = nodeData.input || 'slack'; // Assuming input field stores action type
                actionSlackSettings.classList.toggle('hidden', actionTypeSelect.value !== 'slack');
                actionGoogleDocSettings.classList.toggle('hidden', actionTypeSelect.value !== 'google-doc');
                actionCrmSettings.classList.toggle('hidden', actionTypeSelect.value !== 'crm');
                document.getElementById('slack-channel').value = nodeData.slackChannel || '';
                document.getElementById('slack-message').value = nodeData.slackMessage || '';
                document.getElementById('google-doc-title').value = nodeData.googleDocTitle || '';
                document.getElementById('google-doc-content').value = nodeData.googleDocContent || '';
                document.getElementById('crm-record-id').value = nodeData.crmRecordId || '';
                document.getElementById('crm-field').value = nodeData.crmField || '';
                document.getElementById('crm-value').value = nodeData.crmValue || '';
            } else if (nodeData.type === 'branch') {
                branchSettings.classList.remove('hidden');
                document.getElementById('branch-condition-field').value = nodeData.conditionField || '';
                document.getElementById('branch-condition-operator').value = nodeData.conditionOperator || 'contains';
                document.getElementById('branch-condition-value').value = nodeData.conditionValue || '';
                additionalConditionsContainer.innerHTML = ''; // Clear existing
                if (nodeData.additionalConditions) {
                    nodeData.additionalConditions.forEach((cond, index) => {
                        addConditionToModal(index, cond.field, cond.operator, cond.value);
                    });
                }
            } else if (nodeData.type === 'delay') {
                delaySettings.classList.remove('hidden');
                document.getElementById('delay-duration').value = nodeData.delayDuration || '';
            }

            nodePropertiesModal.classList.add('open');
        }

        function closeNodeProperties() {
            nodePropertiesModal.classList.remove('open');
            currentNodeBeingEdited = null;
        }

        function saveNodeProperties() {
            if (!currentNodeBeingEdited) return;

            const nodeId = currentNodeBeingEdited.dataset.id;
            const nodeData = workflowData.nodes.find(n => n.id === nodeId);

            if (!nodeData) return;

            nodeData.name = nodeNameInput.value;

            if (nodeData.type === 'trigger') {
                nodeData.input = triggerTypeSelect.value;
                nodeData.emailAddress = document.getElementById('email-address').value;
                nodeData.scheduleTime = document.getElementById('schedule-time').value;
                nodeData.scheduleFrequency = document.getElementById('schedule-frequency').value;
            } else if (nodeData.type === 'action') {
                nodeData.input = actionTypeSelect.value;
                nodeData.slackChannel = document.getElementById('slack-channel').value;
                nodeData.slackMessage = document.getElementById('slack-message').value;
                nodeData.googleDocTitle = document.getElementById('google-doc-title').value;
                nodeData.googleDocContent = document.getElementById('google-doc-content').value;
                nodeData.crmRecordId = document.getElementById('crm-record-id').value;
                nodeData.crmField = document.getElementById('crm-field').value;
                nodeData.crmValue = document.getElementById('crm-value').value;
            } else if (nodeData.type === 'branch') {
                nodeData.conditionField = document.getElementById('branch-condition-field').value;
                nodeData.conditionOperator = document.getElementById('branch-condition-operator').value;
                nodeData.conditionValue = document.getElementById('branch-condition-value').value;
                nodeData.additionalConditions = Array.from(additionalConditionsContainer.children).map(el => {
                    return {
                        field: el.querySelector('[name="cond-field"]').value,
                        operator: el.querySelector('[name="cond-operator"]').value,
                        value: el.querySelector('[name="cond-value"]').value
                    };
                });
            } else if (nodeData.type === 'delay') {
                nodeData.delayDuration = document.getElementById('delay-duration').value;
            }

            saveWorkflowToLocalStorage();
            renderWorkflow(); // Re-render to update node display
            closeNodeProperties();
        }

        function deleteCurrentNode() {
            if (currentNodeBeingEdited) {
                removeNode(currentNodeBeingEdited.dataset.id);
                closeNodeProperties();
            }
        }

        // Event Listeners for Modal
        closeModalBtn.addEventListener('click', closeNodeProperties);
        saveNodeBtn.addEventListener('click', saveNodeProperties);
        deleteNodeBtn.addEventListener('click', deleteCurrentNode);

        // --- Sidebar Drag and Drop ---
        sidebarItems.forEach(item => {
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Prevent text selection
                const type = item.dataset.type;
                const name = item.dataset.name;
                const description = item.querySelector('span').textContent;

                const newNode = {
                    id: Date.now().toString(),
                    type,
                    name,
                    description,
                    x: e.clientX - workflowCanvas.getBoundingClientRect().left,
                    y: e.clientY - workflowCanvas.getBoundingClientRect().top,
                    input: '', // Default input
                    emailAddress: '', // For triggers
                    scheduleTime: '', // For triggers
                    scheduleFrequency: 'daily', // For triggers
                    slackChannel: '', // For actions
                    slackMessage: '', // For actions
                    googleDocTitle: '', // For actions
                    googleDocContent: '', // For actions
                    crmRecordId: '', // For actions
                    crmField: '', // For actions
                    crmValue: '', // For actions
                    conditionField: '', // For branches
                    conditionOperator: 'contains', // For branches
                    conditionValue: '', // For branches
                    additionalConditions: [], // For branches
                    delayDuration: '' // For delays
                };
                workflowData.nodes.push(newNode);
                saveWorkflowToLocalStorage();
                renderWorkflow();

                // Simulate a drag after dropping from sidebar
                const droppedNodeEl = workflowCanvas.querySelector(`[data-id="${newNode.id}"]`);
                if (droppedNodeEl) {
                    handleNodeDragStart(e, droppedNodeEl); // Start drag from the drop point
                }
            });
        });

        // --- Modal Dynamic Settings ---
        triggerTypeSelect.addEventListener('change', (e) => {
            triggerEmailSettings.classList.toggle('hidden', e.target.value !== 'email');
            triggerScheduleSettings.classList.toggle('hidden', e.target.value !== 'schedule');
        });

        actionTypeSelect.addEventListener('change', (e) => {
            actionSlackSettings.classList.toggle('hidden', e.target.value !== 'slack');
            actionGoogleDocSettings.classList.toggle('hidden', e.target.value !== 'google-doc');
            actionCrmSettings.classList.toggle('hidden', e.target.value !== 'crm');
        });

        addAnotherConditionBtn.addEventListener('click', () => {
            const field = document.getElementById('branch-condition-field').value;
            const operator = document.getElementById('branch-condition-operator').value;
            const value = document.getElementById('branch-condition-value').value;

            if (field && operator && value) {
                addConditionToModal(additionalConditionsContainer.children.length, field, operator, value);
                // Clear main fields after adding
                document.getElementById('branch-condition-field').value = '';
                document.getElementById('branch-condition-operator').value = 'contains';
                document.getElementById('branch-condition-value').value = '';
            }
        });

        function addConditionToModal(index, field, operator, value) {
            const conditionRow = document.createElement('div');
            conditionRow.classList.add('condition-row');
            conditionRow.innerHTML = `
                <input type="text" name="cond-field" value="${field}" placeholder="Field" class="flex-grow bg-[var(--color-card-bg)] border border-[var(--color-border-dark)] rounded-md p-2 text-sm text-[var(--color-text-light)]">
                <select name="cond-operator" class="select-field w-24">
                    <option value="contains" ${operator === 'contains' ? 'selected' : ''}>contains</option>
                    <option value="equals" ${operator === 'equals' ? 'selected' : ''}>equals</option>
                    <option value="greaterThan" ${operator === 'greaterThan' ? 'selected' : ''}>is greater than</option>
                    <option value="lessThan" ${operator === 'lessThan' ? 'selected' : ''}>is less than</option>
                </select>
                <input type="text" name="cond-value" value="${value}" placeholder="Value" class="flex-grow bg-[var(--color-card-bg)] border border-[var(--color-border-dark)] rounded-md p-2 text-sm text-[var(--color-text-light)]">
                <button class="remove-condition" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            additionalConditionsContainer.appendChild(conditionRow);

            conditionRow.querySelector('.remove-condition').addEventListener('click', (e) => {
                const indexToRemove = parseInt(e.target.dataset.index);
                const parentConditions = Array.from(additionalConditionsContainer.children);
                parentConditions.splice(indexToRemove, 1);
                // Re-render or re-index if needed
                additionalConditionsContainer.innerHTML = '';
                parentConditions.forEach((condEl, i) => {
                    additionalConditionsContainer.appendChild(condEl);
                    condEl.querySelector('.remove-condition').dataset.index = i; // Update index
                });
            });
        }

        // Initial load
        loadWorkflowFromLocalStorage();
        renderWorkflow();
    </script>
</body>
</html>